/*
 * GNU GENERAL PUBLIC LICENSE
 * Version 3, 29 June 2007
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

/*
 * GNU GENERAL PUBLIC LICENSE
 * Version 3, 29 June 2007
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

/*
 * GNU GENERAL PUBLIC LICENSE
 * Version 3, 29 June 2007
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

/*
 * GNU GENERAL PUBLIC LICENSE
 * Version 3, 29 June 2007
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

/*
 * GNU GENERAL PUBLIC LICENSE
 * Version 3, 29 June 2007
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

/*
 * GNU GENERAL PUBLIC LICENSE
 * Version 3, 29 June 2007
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

/*
 * GNU GENERAL PUBLIC LICENSE
 * Version 3, 29 June 2007
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

/*
 * GNU GENERAL PUBLIC LICENSE
 * Version 3, 29 June 2007
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

/*
 * GNU GENERAL PUBLIC LICENSE
 * Version 3, 29 June 2007
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

/*
 * GNU GENERAL PUBLIC LICENSE
 * Version 3, 29 June 2007
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

/*
 * GNU GENERAL PUBLIC LICENSE
 * Version 3, 29 June 2007
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

/*
 * GNU GENERAL PUBLIC LICENSE
 * Version 3, 29 June 2007
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

package it.mikeslab.command.inventory;

import com.cryptomorin.xseries.XMaterial;
import de.themoep.inventorygui.DynamicGuiElement;
import de.themoep.inventorygui.InventoryGui;
import de.themoep.inventorygui.StaticGuiElement;
import it.mikeslab.Main;
import it.mikeslab.util.ItemStackUtil;
import it.mikeslab.util.Translator;
import it.mikeslab.util.currency.CurrencyUtil;
import it.mikeslab.util.language.LangKey;
import it.mikeslab.util.language.Language;
import it.mikeslab.util.math.MathUtil;
import it.mikeslab.util.transactions.EconomyManager;
import it.mikeslab.util.transactions.Transaction;
import it.mikeslab.util.transactions.TransactionUtil;
import it.mikeslab.util.transactions.TransferResult;
import net.wesjd.anvilgui.AnvilGUI;
import org.bukkit.Material;
import org.bukkit.OfflinePlayer;
import org.bukkit.entity.Player;
import org.bukkit.inventory.ItemStack;

import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.concurrent.CompletableFuture;

/**
 * The type Inventory exchange.
 */
public class InventoryExchange {

    /**
     * Open exchange inventory.
     *
     * @param player           the player
     * @param subject          the subject
     * @param creditCardNumber the credit card number
     * @param currencyFrom     the currency from
     * @param currencyTo       the currency to
     * @param value            the value
     */
    public static void openExchangeInventory(Player player, OfflinePlayer subject, String creditCardNumber, String currencyFrom, String currencyTo, double value) {

        String[] setup = {
                "         ",
                " a b c d ",
                "    e    "
        };

        InventoryGui inventoryGui = new InventoryGui(Main.getInstance(), Language.getComponentString(LangKey.EXCHANGE), setup);

        EconomyManager economyManager = Main.getInstance().getEconomyManager();
        List<String> messages = Translator.legacyListTranslate(economyManager.getBalanceMessages(creditCardNumber, subject));


        boolean validExchange = currencyTo != null && currencyFrom != null && value > 0;

        double exchangeRate = 0.0;


        if(validExchange) {
            exchangeRate = CurrencyUtil.getExchangeRates().get(currencyTo).get(currencyFrom);
        }

        double fromValue = MathUtil.round(value * exchangeRate);


        ItemStack currencyFromStack = currencyFrom == null ? ItemStackUtil.createStack(XMaterial.WHITE_WOOL, Language.getComponentString(LangKey.SELECT_CURRENCY_ITEM_NAME)) : ItemStackUtil.createStack(XMaterial.LIME_WOOL, Translator.legacyTranslate("<green>" + currencyFrom));
        ItemStack currencyToStack = currencyTo == null ? ItemStackUtil.createStack(XMaterial.WHITE_WOOL, Language.getComponentString(LangKey.SELECT_CURRENCY_ITEM_NAME)) : ItemStackUtil.createStack(XMaterial.LIME_WOOL, Translator.legacyTranslate("<green>" + value + " " + currencyTo));
        ItemStack exchangeItemStack = validExchange ? ItemStackUtil.createStack(XMaterial.LIME_CONCRETE_POWDER, Translator.legacyTranslate("<green>" + Language.getString(LangKey.EXCHANGE)), Collections.singletonList(Translator.legacyTranslate("<gray>" + (fromValue + " " + currencyFrom) + " -> " + (value + " " + currencyTo)))) : ItemStackUtil.createStack(XMaterial.RED_WOOL, Translator.legacyTranslate("<red>" + Language.getComponentString(LangKey.EXCHANGE)));

        inventoryGui.addElement(new DynamicGuiElement('a', (viewer) -> {
            return new StaticGuiElement('a', ItemStackUtil.createStack(XMaterial.SPECTRAL_ARROW, Translator.legacyTranslate("<green>" + Language.getString(LangKey.BALANCE)), messages), click -> {
                inventoryGui.draw();
                return true;
            });
        }));

        inventoryGui.addElement(new StaticGuiElement('b', currencyFromStack, click -> {
            openInputAnvil(player, Language.getComponentString(LangKey.EXCHANGE_FROM), "<Currency>").thenAccept(currency -> {
                if (currency != null) {
                    if (CurrencyUtil.isCurrency(currency)) {
                        openExchangeInventory(player, subject, creditCardNumber, currency.toUpperCase(), currencyTo, value);
                    } else {
                        player.sendMessage(Language.getComponentString(LangKey.INVALID_CURRENCY));
                    }
                }
            });
            return true;
        }));

        inventoryGui.addElement(new StaticGuiElement('c', currencyToStack, click -> {
            openInputAnvil(player, Language.getComponentString(LangKey.EXCHANGE_TO), "<Amount> <Currency>").thenAccept(inputValue -> {
                if (inputValue != null) {
                    String[] split = inputValue.split(" ");
                    double parseDouble;

                    if (split.length != 2) {
                        player.sendMessage(Language.getComponentString(LangKey.INVALID_VALUE));
                        player.closeInventory();
                        return;
                    }

                    if (!CurrencyUtil.isCurrency(split[1].toUpperCase())) {
                        player.sendMessage(Language.getComponentString(LangKey.INVALID_CURRENCY));
                        player.closeInventory();
                        return;
                    }

                    try {
                        parseDouble = Double.parseDouble(split[0]);
                    } catch (NumberFormatException e) {
                        player.sendMessage(Language.getComponentString(LangKey.INVALID_NUMBER));
                        player.closeInventory();
                        return;
                    }

                    if (parseDouble <= 0) {
                        player.sendMessage(Language.getComponentString(LangKey.AMOUNT_MUST_BE_POSITIVE));
                        player.closeInventory();
                        return;
                    }

                    openExchangeInventory(player, subject, creditCardNumber, currencyFrom, split[1].toUpperCase(), parseDouble);

                }
            });
            return true;
        }));

        inventoryGui.addElement(new StaticGuiElement('d', exchangeItemStack, click -> {
            if (validExchange) {
                TransactionUtil transactionUtil = Main.getInstance().getTransactionUtil();
                TransferResult result = economyManager.exchange(subject.getUniqueId(), currencyFrom, currencyTo, value);
                if(result == TransferResult.SUCCESS) {

                    if(transactionUtil.isExchangeTransactionEnabled()) {
                        transactionUtil.addTransaction(new Transaction(Transaction.randomId(), subject.getUniqueId(), subject.getUniqueId(), currencyFrom, Language.getComponentString(LangKey.EXCHANGE_TRANSACTION_REASON,
                                Map.of("%currencyFrom%", currencyFrom, "%currencyTo%", currencyTo)),
                                fromValue, System.currentTimeMillis()));
                    }

                    player.sendMessage(Language.getComponentString(LangKey.EXCHANGE_PERFORMED, Map.of(
                            "%value%", "" + fromValue,
                            "%currencyFrom%", "" + currencyFrom,
                            "%finalValue%", "" + value,
                            "%currencyTo%", "" + currencyTo)));
                } else {
                    player.sendMessage(Language.getComponentString(LangKey.INSUFFICIENT_FUNDS));
                }
                inventoryGui.close();
            } else {
                player.sendMessage(Language.getComponentString(LangKey.CANNOT_PERFORM_EXCHANGE));
            }
            return true;
        }));

        inventoryGui.addElement(new StaticGuiElement('e', ItemStackUtil.createStack(XMaterial.BARRIER, Language.getComponentString(LangKey.CLOSE)), click -> {
            inventoryGui.close();
            return true;
        }));

        inventoryGui.setCloseAction(close -> {
            return false;
        });

        inventoryGui.setFiller(ItemStackUtil.getFiller());

        inventoryGui.show(player);
    }

    private static CompletableFuture<String> openInputAnvil(Player subject, String title, String text) {
        CompletableFuture<String> completableFuture = new CompletableFuture<>();

        new AnvilGUI.Builder()
                .onClose(player -> {
                    completableFuture.complete(null);
                })
                .onComplete((completion) -> {
                    completableFuture.complete(completion.getText());
                    return List.of(AnvilGUI.ResponseAction.close());
                })
                .itemLeft(new ItemStack(Material.PAPER))
                .title(title)
                .text(text)
                .plugin(Main.getInstance())
                .open(subject);

        return completableFuture;
    }
}
